#!/bin/bash
PATH="/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl"

OPT_DIR="$HOME/.local/opt"

function git_fetch {
	git --git-dir=$1 fetch --tags
}

function git_latest_tag {
	git --git-dir=$1 describe --tags $(git --git-dir=$1 rev-list --tags --max-count=1)
}

function git_subdirs {
	find $1 -name ".git" -type d
}

function is_rust_repo {
	if test -f "./Cargo.toml" ; then
		echo "True"
	else
		echo "False"
	fi
}


MSG="Iterating over all subdirs in: $OPT_DIR" ; echo $MSG
git_dirs=$(git_subdirs $OPT_DIR)
MSG="" ; echo $MSG

for git_dir in $git_dirs ; do
	project_full_path=$(dirname $git_dir)
	project_name=$(basename $project_full_path)
	MSG="Target: $project_name" ; echo $MSG
	MSG="Fetching origin..." ; echo $MSG
	git_fetch $git_dir
	MSG="Getting the latest tag..." ; echo $MSG
	latest_tag=$(git_latest_tag $git_dir)
	MSG="The latest tag is: $latest_tag" ; echo $MSG
	MSG="Changing dir to $project_full_path" ; echo $MSG
	cd $project_full_path
	MSG="Checkout to $latest_tag" ; echo $MSG
	git checkout -b $latest_tag 2>/dev/null
	MSG="Checking if it is a Rust repository..." ; echo -n $MSG
	is_rust_repo_res=$(is_rust_repo)
	MSG="\t$is_rust_repo_res" ; echo -e $MSG
	if [ $is_rust_repo_res = "True" ] ; then
		MSG="Updating deps..." ; echo $MSG
		cargo update
		MSG="Building the binary..." ; echo $MSG
		cargo build --release
	fi
	MSG="" ; echo $MSG
done
